name: Send Timberline portfolio update notification

on:
  workflow_dispatch:

jobs:
  send-portfolio-update:
    runs-on: ubuntu-latest
    env:
      ADMIN_API_KEY: ${{ secrets.TIMBERLINE_ADMIN_API_KEY }}
    steps:
      - name: Send portfolio update notifications
        run: |
          if [ -z "$ADMIN_API_KEY" ]; then
            echo "ADMIN_API_KEY GitHub secret (TIMBERLINE_ADMIN_API_KEY) is not set."
            exit 1
          fi

          TOKENS_JSON=$(curl -s -X GET "https://timberline-app-emj2.vercel.app/api/push-tokens" \
            -H "X-Admin-Api-Key: $ADMIN_API_KEY")

          echo "Fetched tokens from backend"

          # Process each token one at a time: read token, send notification
          echo "$TOKENS_JSON" | jq -r '.tokens[].token' | while read -r TOKEN; do
            if [ -z "$TOKEN" ]; then
              continue
            fi

            echo "Sending notification to $TOKEN"

            BODY=$(jq -n \
              --arg to "$TOKEN" \
              --arg title "New Timberline portfolio update" \
              --arg body "Portfolio update available. Open Timberline to see what changed." \
              '{to: $to, sound: "default", title: $title, body: $body, data: {source: "github-action", intent: "portfolio-update"}}')

            curl -s -X POST https://exp.host/--/api/v2/push/send \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -d "$BODY"

            echo ""
          done


